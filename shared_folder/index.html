<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shared Video Folder with Checklist</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        video, img, embed { display: block; margin-bottom: 10px; max-width: 100%; }
        label { font-weight: bold; }
        #content { display: none; }
        #previewArea { border: 1px solid #999; padding: 15px; margin-top: 20px; width: 640px; height: auto; }
        input[type=text], input[type=password] { padding: 5px; font-size: 16px; }
        button { padding: 6px 12px; font-size: 16px; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Welcome to My Shared Video Folder</h1>

    <!-- ðŸ”‘ Login form -->
    <div id="loginForm">
        <p>Login with your username and password:</p>
        <input type="text" id="username" placeholder="Username"><br><br>
        <input type="password" id="password" placeholder="Password"><br><br>
        <button onclick="login()">Login</button>
    </div>

    <!-- âœ… Content visible after login -->
    <div id="content">
        <p>Kindly ensure that videos are watched and documents are reviewed thoroughly before marking them as completed.</p>
        <ul>
            <li>
                <video id="video1" width="320" height="240" controls>
                    <source src="MySecretDocs/video1.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <button onclick="markCompleted('video1.mp4')">Mark video1.mp4 as Completed</button>
            </li>
            <li>
                <video id="video2" width="320" height="240" controls>
                    <source src="MySecretDocs/video2.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <button onclick="markCompleted('video2.mp4')">Mark video2.mp4 as Completed</button>
            </li>
            <li>
                <button onclick="previewFile('doc1.pdf', 'pdf')">Preview doc1.pdf</button>
                <button onclick="markCompleted('doc1.pdf')">Mark doc1.pdf as Completed</button>
            </li>
            <li>
                <button onclick="previewFile('image1.png', 'image')">Preview image1.png</button>
                <button onclick="markCompleted('image1.png')">Mark image1.png as Completed</button>
            </li>
        </ul>
        <div id="previewArea"><p><strong>Preview will appear here:</strong></p></div>
    </div>

    <script>
        const myName = "Shirani Singhal";
        let visitorName = '';
        let token = ''; // ðŸ”‘ store JWT here

        // âœ… Update to match your backend
        const socket = io("https://folder-tracker-project-1-fu84.onrender.com", { transports: ["websocket"] });

        // ðŸ”‘ Login function
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert("Enter both username and password!");
                return;
            }

            fetch('/api/login', {
                method: 'POST',
                body: JSON.stringify({ username, password }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    token = result.token;
                    visitorName = username;

                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('content').style.display = 'block';

                    const data = { 
                        timestamp: new Date().toISOString(), 
                        visitor: visitorName, 
                        action: 'logged in', 
                        url: window.location.href 
                    };

                    fetch('/api/log-visit-protected', {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    socket.emit("visit_event", data);
                } else {
                    alert("Login failed: " + result.message);
                }
            })
            .catch(() => alert("Login request failed"));
        }

        // âœ… Mark file as completed
        function markCompleted(fileName) {
            alert(`User: ${visitorName}\nFile Completed: ${fileName}`);

            const data = { 
                timestamp: new Date().toISOString(), 
                visitor: visitorName, 
                action: 'marked file as completed', 
                file: fileName 
            };

            fetch('/api/log-visit-protected', { 
                method: 'POST', 
                body: JSON.stringify(data), 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            });

            socket.emit("visit_event", data);
        }

        // âœ… Preview file
        function previewFile(fileName, type) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';

            if (type === 'pdf') {
                const embed = document.createElement('embed');
                embed.src = `MySecretDocs/${fileName}`;
                embed.width = '640'; embed.height = '480'; embed.type = 'application/pdf';
                previewArea.appendChild(embed);
            } else if (type === 'image') {
                const img = document.createElement('img');
                img.src = `MySecretDocs/${fileName}`;
                img.width = 640; img.alt = 'Preview Image';
                previewArea.appendChild(img);
            }
        }
    </script>
</body>
</html>
